### :link: 2025-08-06
- [이미지 기반 RAG 실습](#이미지-기반-rag-실습)
 
&nbsp;
### 이미지 기반 RAG 실습 
#### 1) 개념
**전체 흐름**

* 풍미 요약
* 와인 리뷰 **Pinecone**에서 검색
* **RAG (Retrieval-Augmented Generation)** 기반 와인 추천


**구조**

* **입력**: 음식 이미지
* **중간 처리**:

  * 이미지 → 풍미 요약 (`describe_dish_flavor`)
  * 풍미 → 유사 와인 리뷰 검색 (`search_wines`)
  * **결과**: 음식 이미지에 어울리는 와인 추천 (`recommend_wines`)

#### 2) 코드 예시

**이미지 → 풍미 요약**

```python
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser

def describe_dish_flavor(query):
    prompt = ChatPromptTemplate.from_messages([
        ('system', """ 
        Persona: 당신은 고급 음식 전문가로, 풍미 분석과 식재료 조화에 대한 깊은 통찰을 갖고 있습니다.
        Role: 요리 풍미를 분석하고, 맛·식감·조리법을 설명합니다.
        """),
        ('user', '이미지의 요리명과 풍미를 한 문장으로 요약해주세요.')
    ])
    prompt += HumanMessagePromptTemplate.from_template([query])
    model = ChatOpenAI(model_name='gpt-4.1-mini', temperature=0)
    output_parser = StrOutputParser()
    chain = prompt | model | output_parser
    return chain
```

**풍미 → 유사 와인 리뷰 검색**

```python
from langchain_openai.embeddings import OpenAIEmbeddings
from langchain_pinecone import PineconeVectorStore

def search_wines(query):
    embeddings = OpenAIEmbeddings(model='text-embedding-3-small')
    vector_db = PineconeVectorStore(
        embedding=embeddings,
        index_name=os.getenv("PINECONE_INDEX_NAME"),
        namespace=os.getenv("PINECONE_NAMESPACE"),
        pinecone_api_key=os.getenv("PINECONE_API_KEY")
    )
    results = vector_db.similarity_search(query, k=5)
    return {
        "dish_flavor": query,
        "wine_reviews": '\n'.join([doc.page_content for doc in results])
    }
```

* (Pinecone 기반 RAG)

**음식 이미지에 어울리는 와인 추천**

```python
def recommend_wines(query):
    prompt = ChatPromptTemplate.from_messages([
        ('system', """ 
        Persona: 당신은 와인에 정통한 소믈리에입니다.
        Role: 음식 풍미와 와인 리뷰를 바탕으로 적절한 와인을 추천하세요.
        """),
        HumanMessagePromptTemplate.from_template("""
        와인 페어링 추천에 아래의 요리와 풍미, 와인 리뷰만을 참고하여 한글로 답변해주세요.
        요리와 풍미:
        {dish_flavor}
        와인 리뷰:
        {wine_reviews}
        """)
    ])
    model = ChatOpenAI(model='gpt-4.1-mini', temperature=1)
    output_parser = StrOutputParser()
    chain = prompt | model | output_parser
    return chain
```

**전체 체인 연결**

```python
from langchain_core.runnables import RunnableLambda

chain = (
    RunnableLambda(describe_dish_flavor) |
    RunnableLambda(search_wines) |
    RunnableLambda(recommend_wines)
)

chain.invoke({
    "image_url": "토마토 파스타 사진 주소, 생략"
})
```
---

**결과**
  ```
스파게티 알리오 올리오는 마늘의 고소함과 신선한 방울토마토의 깔끔하면서 은은한 매운맛과 감칠맛이 조화를 이루는 요리입니다. 이 요리에는 산뜻한 산미와 적당한 풍미가 조화로운 화이트 와인이 잘 어울립니다.

추천 와인은 미국 캘리포니아 파소 로블레스 지역의 Clavo Cellars 2012 Ole Albariño입니다. 이 와인은 캐모마일, 말린 오렌지 껍질, 허브 향이 독특하며, 스모크 레몬 껍질과 오레가노 등 다양한 허브 풍미가 입안에서 느껴집니다. 깔끔하면서도 복합적인 맛이 스파게티 알리오 올리오의 마늘과 토마토 풍미를 한층 돋보이게 해줍니다.

또한, 산미가 적당해 요리의 은은한 매운맛과 감칠맛을 밸런스 있게 잡아주어 전반적인 식사 경험을 더욱 풍부하게 할 것입니다. 가격도 합리적이어서 부담 없이 즐기시기에 좋습니다.

요약:  
- 와인: Clavo Cellars 2012 Ole Albariño (미국, 파소 로블레스)  
- 추천 이유: 신선한 허브 향과 산미가 스파게티 알리오 올리오의 마늘과 토마토와 잘 어울림  
- 특징: 허브, 스모키, 시트러스 풍미, 깔끔한 마무리

즐거운 와인 페어링 되시길 바랍니다!
  ```