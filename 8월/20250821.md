### :link: 2025-08-21
- [사용자 맥락 분기 처리](#1-사용자-맥락-분기-처리)
- [동적 응답 메시지 생성](#2-동적-응답-메시지-생성)
 
&emsp; 
&nbsp;
### 1. 사용자 맥락 분기 처리
- **기존 사용자 (예약 이력 O)**:    
가장 많이 예약했던 메뉴나 샵을 다시 예약하도록 유도하는 `_handle_re_recommendation` 호출
- **신규 사용자 (예약 이력 X)**:    
사용자의 현재 질문을 기반으로 새로운 샵을 추천하는 `_handle_new_search` 호출

```python
# llm/app/handlers/user_reservation_handler.py

async def handle_search_shops(context: Dict[str, Any]) -> Dict[str, Any]:
    """샵 검색 비즈니스 로직"""
    token = context["token"]
    query = context["query"]

    user_history = await get_user_reservation_history(token)

    if user_history:
        # 예약 내역이 있으면 재예약 추천
        return await _handle_re_recommendation(user_history)
    else:
        # 예약 내역이 없으면 신규 검색
        return await _handle_new_search(query)
```

&emsp; 
&nbsp;
### 2. 동적 응답 메시지 생성
- 사용자 검색 키워드 → 추천할 샵 계산 → 추천 메시지 생성     
: 예시) Q. "염색 잘하는 샵 추천해줘"     
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; A. '염색' 관련 메뉴 중 '옴브레 염색'을(를) 보유한 '엘레강스 헤어 잠실점'은(는) 어떠세요?

```python
# llm/app/handlers/user_reservation_handler.py

def _generate_dynamic_recommend_message(...) -> str:
    """검색 조건과 결과에 따라 동적인 추천 메시지를 생성하는 내부 함수."""
    if keyword:
        # 키워드와 관련된 메뉴 중 가장 인기 있는 메뉴를 찾음
        relevant_menus = [menu for menu in recommended_shop.menus if keyword in menu.menuName]
        popular_menu = max(relevant_menus, key=lambda m: m.menuRevCount) if relevant_menus else None
        
        if popular_menu:
            # 인기 메뉴를 포함한 추천 메시지 생성
            return f"'{keyword}' 관련 메뉴 중 '{popular_menu.menuName}'을(를) 보유한 '{recommended_shop.shopName}'은(는) 어떠세요?"
    # ...
```

https://github.com/BOA-with-elephant/Header-backend/pull/233