### :link: 2025-07-31
- [Embeddings](#embeddings)
 
&nbsp;
### Embeddings
#### 1) 개요

임베딩(Embeddings)은 **텍스트를 고차원 수치 벡터로 표현하는 기술**로, 의미 기반의 비교 및 검색을 가능하게 해준다. 

#### 2) 기본 사용법

```python
from openai import OpenAI

client = OpenAI()

text = "내가 오늘 점심을 ... "

response = client.embeddings.create(
    model="text-embedding-3-small",
    input=[text]
)

print(len(response.data[0].embedding)) # 임베딩 벡터의 길이, 1536
```

#### 3) 음식 리뷰 데이터셋 임베딩 처리

**데이터 불러오기 및 토큰 수 계산**

```python
import pandas as pd
import tiktoken

df = pd.read_csv('fine_food_reviews_1k.csv')

gpt4o_encoding = tiktoken.encoding_for_model("gpt-4o")
df['n_tokens'] = df['Text'].apply(lambda x: len(gpt4o_encoding.encode(x)))
df[['Text', 'n_tokens']].head()
```

**임베딩 벡터 변환 함수**

```python
def texts_to_embeddings(texts):
    texts = [text.replace('\n', ' ') for text in texts] # 줄바꿈 제거
    response = client.embeddings.create(
        model="text-embedding-3-small",
        input=texts
    )
    return [data.embedding for data in response.data]

vecs = texts_to_embeddings(["안녕하세요, 저는 김밥나라 우동공주입니다.", "오늘  참 떡볶이 먹고싶은 날씨네요"])
len(vecs), len(vecs[0]), len(vecs[1]) # (2, 1536, 1536)
```

```python
df['embedding'] = texts_to_embeddings(df['Text'].tolist())
```
```zsh
0      [0.01677853614091873, -0.008555943146348, -0.0...
1      [-0.005216312129050493, 0.040469057857990265, ...
2      [0.005564768798649311, -0.012970144860446453, ...
3      [-0.016292475163936615, 0.008886804804205894, ...
4      [-0.004322985652834177, -0.06378211826086044, ...
                             ...                        
995    [0.01910569705069065, -0.037205830216407776, -...
996    [-0.037065695971250534, -0.013630757108330727,...
997    [-0.04671481251716614, -0.07131096720695496, -...
998    [-0.014545817859470844, -0.03374110162258148, ...
999    [0.013911867514252663, -0.013398468494415283, ...
```

**인덱스로 문자열을 사용하는 임베딩 전용 데이터프레임 생성**

```python
emb_df = df['embedding'].to_frame('embedding')
emb_df.index = df['Text']
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>embedding</th>
    </tr>
    <tr>
      <th>Text</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Wanted to save some to bring to my Chicago family but my North Carolina family ate all 4 boxes before I could pack. These are excellent...could serve to anyone</th>
      <td>[0.01677853614091873, -0.008555943146348, -0.0...</td>
    </tr>
    <tr>
      <th>Not pleased at all. When I opened the box, most of the rings were broken in pieces. A total waste of money.</th>
      <td>[-0.005216312129050493, 0.040469057857990265, ...</td>
    </tr>
    <tr>
      <th>I'm not sure that custard is really custard without eggs.  But this comes close.  I got it for use in a "Vegan pancake" recipe.  We were having houseguests who were Vegan and I wanted to make some special breakfasts while they were here.  One of the cooking/recipe sites had a recipe using this and there were lots of great reviews.  I tried the recipe and it turned out like wallpaper paste -- yuck!&lt;br /&gt;However, the  so-called custard isn't so bad.  I think it's probably just cornstarch and annatto (yellow coloring with a slight flavor).  It's fun playing with it.  You could dress it up with fruit.  Seems to come out on the thin side when you make it as directed, so I use less milk because I like my custards to set firm.  As a custard sauce it's fine.  I would say it tastes something between a pudding and a custard.&lt;br /&gt;&lt;br /&gt;If you want a really good egg-free "custard" get an original recipe for "blanc mange."  It takes a lot longer to make, but it's certainly worth the difference.</th>
      <td>[0.005564768798649311, -0.012970144860446453, ...</td>
    </tr>
    <tr>
      <th>I like the fact that you can see what you're getting and that there are no bones or dark meat.  There are 7 nice big chunks in every jar.&lt;br /&gt;&lt;br /&gt;These taste like tuna in a can but, because they're preserved in glass, you don't have to worry about either aluminum or BPA; BUT ... they are not just tuna and spring water.&lt;br /&gt;&lt;br /&gt;There is salt in there, too, and it's not healthy sea salt, it's toxic table salt.&lt;br /&gt;&lt;br /&gt;I am trying to contact Tonnino to confirm that.  I might be wrong because the label states that the ingredients are "tuna fish" but the sticker on the top clarifies that it is the smaller (healthier) yellowfin, so the "salt" listed in the ingredients might be sea salt but, if it was, why don't they say so?&lt;br /&gt;&lt;br /&gt;Without confirmation, I will continue to look for a salt-free olive-oil free tuna preserved in glass.&lt;br /&gt;&lt;br /&gt;If you know of one, please contact me!</th>
      <td>[-0.016292475163936615, 0.008886804804205894, ...</td>
    </tr>
    <tr>
      <th>My dog was suffering with itchy skin.  He had been eating Natural Choice brand (cheaper) since he was a puppy.  I was nervous to change foods.  The vet suggested to change foods sand see if the skin issues cleared up.  Wellness brand did the job.  My dog seems to love the food and the skin issues cleared up within a few weeks.</th>
      <td>[-0.004322985652834177, -0.06378211826086044, ...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>I have ordered these raisins multiple times.  They are always great and arrive timely. I can't go back to store bought chocolate covered raisins now! Love this product.</th>
      <td>[0.01910569705069065, -0.037205830216407776, -...</td>
    </tr>
    <tr>
      <th>My dog will come in from outside when I am training her and look at the cupboard waiting for her treat. When I use the clicker training method she comes because she knows she has something special.</th>
      <td>[-0.037065695971250534, -0.013630757108330727,...</td>
    </tr>
    <tr>
      <th>Wolfgang Puck's Jamaica Me Crazy is that wonderful blend of island flavors in a coffee. Have loved it from the first time tasting. Great product.</th>
      <td>[-0.04671481251716614, -0.07131096720695496, -...</td>
    </tr>
    <tr>
      <th>Great product for the price. Mix with the Asian rice crackers for an excellent snack.  Big container lasts a long time. Only lightly slighted. Peanuts are whole and large.</th>
      <td>[-0.014545817859470844, -0.03374110162258148, ...</td>
    </tr>
    <tr>
      <th>My first experience with Maui Coffee was bringing it back from Maui as a souvenier. I called Maui Coffee Manufacting to order more, Shipping was a bit expensive. Originally,I would bring it back from Maui for souveniers for my friends and family on the mainland. They loved it so much I called Maui coffee and ordered more. Once I realized Amazon had Maui Coffee I was so excited and now I can order at my leisure and gift it to all my friends and family. My personal favorites are the flavored blends. (: Thanks!</th>
      <td>[0.013911867514252663, -0.013398468494415283, ...</td>
    </tr>
  </tbody>
</table>
<p>1000 rows × 1 columns</p>
</div>

#### 4) 유사도 기반 검색

**코사인 유사도 정의**

```python
import numpy as np

cos_sim = lambda a, b: np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))
```

**검색 함수 구현**

```python
def get_similar_texts(query, emb_df, top_n=5):
    query_emb = texts_to_embeddings(query)[0]
    emb_df['cos_sim'] = emb_df['embedding'].apply(lambda x: cos_sim(x, query_emb))
    top_n_texts = emb_df.sort_values('cos_sim', ascending=False).head(top_n)
    return top_n_texts
```

**예시 실행**

```python
get_similar_texts(['cherry'], emb_df)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>embedding</th>
      <th>cos_sim</th>
    </tr>
    <tr>
      <th>Text</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>If you love a good Manhattan and especially enjoy the cherry at the end, these cherries are for you.&lt;br /&gt;&lt;br /&gt;Very dense, sweet and in a syrup, two cherries and a bit of syrup add a better sweet component than sweet vermouth. These things were born to be in a Manhattan!  Also recommend skipping the vermouth and adding the Italian liquor Amaro.  That and these cherries will change your Manhattan experience forever</th>
      <td>[-0.0077921245247125626, -0.008809339255094528...</td>
      <td>0.514957</td>
    </tr>
    <tr>
      <th>This is my third box of the cherries.  I love putting a handful on my cereal in the morning.  They are very sweet and just a bit tart.  They are also great in salads and make a awesome muffin.&lt;br /&gt;&lt;br /&gt;I will say that there seems to be some seasonal variation.  One of the three boxes I received wasn't quite as tart/sweet as the other two.  They were still very good but not "as" good.</th>
      <td>[-0.00831146351993084, -0.023813309147953987, ...</td>
      <td>0.455998</td>
    </tr>
    <tr>
      <th>I never cared much for the original Cherry Coke, but I love the new Cherry Zero version. Twelve cans just don't last long around me as I will drink one after another.</th>
      <td>[0.04037198796868324, -0.011308384127914906, -...</td>
      <td>0.391941</td>
    </tr>
    <tr>
      <th>I LOVE the Blue Sky Wild Raspberry but I cannot stand the Black Cherry.  It doesn't have much flavor and it has an awful aftertaste.  UGH!</th>
      <td>[0.01582026481628418, -0.024021638557314873, -...</td>
      <td>0.386142</td>
    </tr>
    <tr>
      <th>These plums are sweet and juicy, and the aroma is like perfume.  And it doesn't hurt that they are good for you, too.</th>
      <td>[0.019921528175473213, 0.010799133218824863, -...</td>
      <td>0.353239</td>
    </tr>
  </tbody>
</table>
</div>

> 임베딩은 Retrieval-Augmented Generation(RAG) 기반 응용에 매우 중요하며, LLM의 정확도와 맥락 이해도를 향상시킬 수 있다.
