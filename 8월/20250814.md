### :link: 2025-08-27
- [로컬 캐시(Caffeine) 도입 및 성능 개선](#0-로컬-캐시caffeine-도입-및-성능-개선) 
- [캐시 구현과 자기 순환 참조 문제 해결](#1-캐시-구현과-자기-순환-참조-문제-해결)
 
&nbsp; 
### 0. 로컬 캐시(Caffeine) 도입 및 성능 개선

여러 캐시 구현체 중, 외부 의존성 없이 간결하게 적용할 수 있는 Caffeine을 이용하여 캐시 정책을 도입했다.   
캐시 적용 결과, **100개의 동시 요청 테스트에서 API의 평균 응답 시간이 약 7배 감소**하는 눈에 띄는 성능 향상을 확인할 수 있었다.

```java
// build.gradle
dependencies {
    // ...
    implementation 'org.springframework.boot:spring-boot-starter-cache' // 캐시 스타터 의존성 추가
    implementation 'com.github.ben-manes.caffeine:caffeine' // Caffeine 의존성 추가
}

@EnableCaching // 애플리케이션에 캐싱 기능을 활성화
@SpringBootApplication
public class HeaderBackendApplication {
    // ...
```

&emsp; 
&nbsp;
### 1. 캐시 구현과 자기 순환 참조 문제 해결

스프링 캐시의 어노테이션을 활용해 캐시 로직을 적용했습니다.

  - `@Cacheable`  
  : 데이터를 조회하는 메소드에 사용   
    캐시에 데이터가 있으면 메소드를 실행하지 않고 즉시 반환하며, 없으면 메소드를 실행하고 결과를 캐시에 저장
  - `@CacheEvict`   
  : 데이터에 변경이 발생하는 메소드(수정/삭제)에 사용   
  메소드 실행 후 캐시의 데이터를 제거하여 데이터 정합성을 유지

```java
// HolidayExaminationForCache.java
@Cacheable(value = "holidays", key = "#shopCode + '_' + #dateToScan.toString()")
public boolean isHoliday(Shop shop) {
    // DB 조회
}

@CacheEvict(cacheNames = "holidays", key = "#shopId")
public void updateHolidays(Long shopId, ...) {
    // 휴무일 정보 변경
}
```

캐시를 적용하는 과정에서, `@Cacheable`이 붙은 메소드가 같은 클래스 내의 다른 `@Cacheable` 메소드를 호출할 때 캐시가 동작하지 않는 **자기 순환 참조(self-invocation)** 문제를 발견했습니다. 이는 스프링의 AOP 프록시 방식 때문에 발생하는 문제였다.

이 문제를 해결하기 위해 기존 `ShopService`에 있던 휴무일 판단 로직(`isHoliday`)을 별도의 컴포넌트(`HolidayExaminationForCache`)로 분리했다.

```java
// 수정 전: UserReservationService 내부에서 isHoliday 호출 (캐시 동작 안함)
    if (this.isHoliday(shopCode, resvDate)) {
            throw new UserReservationExceptionHandler(UserReservationErrorCode.DATE_HAS_HOL);
    }


// 수정 후: 별도의 validator 호출 (캐시 정상 동작)
    if (examinationForCache.isHoliday(shopCode, resvDate)) {
            throw new UserReservationExceptionHandler(UserReservationErrorCode.DATE_HAS_HOL);
    }
```

- 스프링의 선언적 캐시 기능을 구현할 때, AOP 프록시의 동작 원리를 이해해야 한다.
- 자기 순환 참조 문제가 발생할 경우, 메소드를 별도의 클래스로 분리해야 한다.

---

그러나, `Caffeine`은 로컬 캐시이므로 서버가 재시작되면 모든 캐시 데이터가 사라지는 단점이 있다. 따라서 추후 서버 안정화 단계에서는 분산 캐시 시스템인 `Redis`로 전환할 계획이다.

추후 기능 개발 시에는 자주 조회되는 데이터가 있다면 이를 확인하고, 캐시를 적용할 것이다.

https://github.com/BOA-with-elephant/Header-backend/pull/204