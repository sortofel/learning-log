### :link: 2025-07-23
- [WebClient 개념](#1-webclient-개념)
- [카카오맵 API 호출 예시](#2-카카오맵-api-호출-예시)
- [응답 데이터를 DTO로 매핑](#3-응답-데이터를-dto로-매핑)
- [WebClient의 구성 방식](#4-webclient의-구성-방식)
 
&nbsp;
### 1. WebClient 개념

#### 1) WebClient는 무엇인가
- Spring 5부터 지원되는 비동기 HTTP 클라이언트임
- RestTemplate의 대체제 역할을 함
- 논블로킹으로 작동하지만, 블로킹 방식도 선택 가능함

#### 2) WebClient의 장점
- 비동기 처리에 최적화되어 있어 성능이 우수함
- 유연하게 요청/응답 헤더, 파라미터, 바디를 구성할 수 있음
- JSON, XML, 스트림 등 다양한 형태를 지원함

#### 3) 기본 사용 예시
```java
WebClient webClient = WebClient.create();

String response = webClient.get()
  .uri("https://api.example.com/data")
  .retrieve()
  .bodyToMono(String.class)
  .block(); // 응답을 기다림 (블로킹)
```

- `.retrieve()`는 HTTP 응답을 받아오는 단계  
- `.bodyToMono()`는 응답 데이터를 단일 객체로 변환  
- `.block()`은 응답을 기다릴 때 사용 (동기적으로 동작함)

---

### 2. 카카오맵 API 호출 예시

#### 1) 주소 → 좌표 변환 예제
```java
String KAKAO_API_KEY = "KakaoAK " + kakaoKey;

WebClient webClient = WebClient.builder()
    .baseUrl("https://dapi.kakao.com")
    .defaultHeader(HttpHeaders.AUTHORIZATION, KAKAO_API_KEY)
    .build();

String query = "서울 중구 을지로";

String result = webClient.get()
    .uri(uriBuilder ->
        uriBuilder.path("/v2/local/search/address.json")
                  .queryParam("query", query)
                  .build()
    )
    .retrieve()
    .bodyToMono(String.class)
    .block();
```

- `.baseUrl()`로 기본 주소 지정  
- 카카오 API는 `Authorization` 헤더에 `KakaoAK {REST_API_KEY}` 형식으로 인증함  
- 쿼리 파라미터는 `.queryParam()`으로 설정  
- 응답은 JSON 문자열 그대로 받을 수도 있고, DTO로 매핑도 가능함  

---

### 3. 응답 데이터를 DTO로 매핑

#### 1) 예시 DTO 클래스
```java
@Data
public class KakaoAddressResponse {
  private List<Document> documents;

  @Data
  public static class Document {
    private String addressName;
    private double x; // 경도
    private double y; // 위도
  }
}
```

#### 2) 응답 매핑 예시
```java
KakaoAddressResponse response = webClient.get()
    .uri(...) // 위 예시와 동일
    .retrieve()
    .bodyToMono(KakaoAddressResponse.class)
    .block();
```

- JSON 구조에 맞춰 DTO 클래스 계층을 정의해야 함  
- 응답을 문자열(String)로 받고, `ObjectMapper`로 수동 변환할 수도 있음  

---

### 4. WebClient의 구성 방식

#### 1) 싱글톤으로 Bean 등록 (실무 권장)
```java
@Configuration
public class WebClientConfig {

  @Bean
  public WebClient kakaoWebClient(@Value("${kakao.api.key}") String kakaoKey) {
    return WebClient.builder()
        .baseUrl("https://dapi.kakao.com")
        .defaultHeader(HttpHeaders.AUTHORIZATION, "KakaoAK " + kakaoKey)
        .build();
  }
}
```

- 매번 WebClient를 새로 만들지 않고 빈으로 주입받아 사용  
- 설정값은 `.yml`에서 관리하는 게 깔끔함

#### 2) 사용 시 주입
```java
@Service
public class KakaoMapService {
  
  private final WebClient kakaoWebClient;

  public KakaoMapService(WebClient kakaoWebClient) {
    this.kakaoWebClient = kakaoWebClient;
  }

  public LocationDto getCoordinates(String address) {
    // webClient 호출 로직
  }
}
```

---

### 5. 기타 유의 사항

#### 1) 예외 처리
- `.onStatus()`로 HTTP 에러 코드 처리 가능  
```java
.retrieve()
.onStatus(HttpStatus::is4xxClientError, response -> ...)
```

#### 2) 비동기 처리
- `.block()`을 쓰지 않으면 `Mono<T>` 또는 `Flux<T>` 반환됨  
- WebFlux와 함께 사용할 때는 비동기 그대로 두는 게 좋음  
- 일반 MVC 환경에서는 `.block()`으로 동기 처리해도 괜찮음

#### 3) timeout 처리
- 기본 WebClient는 timeout 설정이 없음  
- 커넥션/응답 제한 시간은 `HttpClient`로 설정해야 함

---

- WebClient는 HTTP 통신을 유연하게 구성할 수 있는 매우 강력한 도구임  
- 단순히 JSON 데이터를 요청-응답하는 것뿐 아니라, OAuth 인증, 파일 다운로드 등 다양한 작업에 사용 가능함  
- 카카오 API와 같은 외부 서비스를 호출할 때 WebClient를 사용하면 코드도 깔끔하고 테스트하기도 좋음
